<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Evropa mÄ›sta â€“ Quiz</title>

<link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,600;9..144,800&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --claret:#670628;
  --pink:#FFBDC5;
  --choco:#48261D;
  --sky:#B2CDFF;
  --paper:#fff7f9;

  --dot:#0420f9;
  --good:#16a34a;
  --bad:#cc0000;
}

*{ box-sizing:border-box; }
html, body{ margin:0; padding:0; overflow-x:hidden; }
body{
  font-family: Inter, Arial, sans-serif;
  background: var(--paper);
  color: var(--choco);
}

/* Title bar */
#pageTitleBar{
  background: var(--claret);
  border-bottom: 1px solid rgba(255,255,255,0.18);
  padding: 12px;
  text-align: center;
}
#topTitle{
  font-family: Fraunces, serif;
  font-weight: 800;
  letter-spacing: 0.5px;
  color: var(--pink);
  font-size: clamp(18px, 2vw, 26px);
}

/* Floating Find (stays on top) */
#findSticky{
  position: fixed;
  top: 70px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  padding: 10px 12px;
  display:flex;
  justify-content:center;
  background: transparent;
  pointer-events: none;
}
#findText{
  pointer-events: auto;
  font-family: Fraunces, serif;
  font-weight: 800;
  letter-spacing: 0.3px;
  color: var(--choco);
  background: var(--pink);
  font-size: clamp(22px, 3vw, 40px);
  padding: 12px 22px;
  border-radius: 18px;
  border: 1px solid rgba(72,38,29,0.25);
  box-shadow: 0 10px 25px rgba(0,0,0,0.18);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: min(1100px, 95vw);
}

/* Wrong feedback: quick shake + red border */
@keyframes shake {
  0%,100% { transform: translateX(-50%) translateX(0); }
  20% { transform: translateX(-50%) translateX(-8px); }
  40% { transform: translateX(-50%) translateX(8px); }
  60% { transform: translateX(-50%) translateX(-6px); }
  80% { transform: translateX(-50%) translateX(6px); }
}
#findSticky.wrong { animation: shake 220ms linear; }
#findText.wrong { border-color: var(--bad); box-shadow: 0 10px 25px rgba(204,0,0,0.28); }

.container{
  width: 100%;
  padding: 14px 0 24px;
}

/* Pink card */
.map-card{
  width: 97vw;
  margin: 0 auto;
  background: var(--pink);
  border-radius: 24px;
  border: 2px solid rgba(72,38,29,0.25);
  box-shadow: 10px 10px 0 rgba(0,0,0,0.16);
  overflow: hidden;
}

/* Tiny status strip */
.top-strip{
  padding: 10px 14px;
  display:flex;
  gap:10px;
  align-items:center;
  border-bottom: 1px solid rgba(72,38,29,0.18);
  background: rgba(255,255,255,0.25);
}
#title{
  font-family: Fraunces, serif;
  font-weight: 800;
  font-size: 16px;
  margin-right: auto;
}
#status{
  font-weight: 800;
  color: rgba(72,38,29,0.85);
}

#viewport{
  width: 100%;
  overflow: auto;
  background: rgba(255,255,255,0.12);
  touch-action: none;                 /* we handle pan/pinch ourselves */
  -webkit-overflow-scrolling: touch;
}
/* Stage has explicit px size so scrollbars work */
#stage{
  position: relative;
  margin: 0 auto;
  background: rgba(255,255,255,0.18);
}

/* Image + canvas fill stage */
#map{
  position:absolute;
  inset:0;
  width: 100%;
  height: 100%;
  display:block;
  user-select: none;
  -webkit-user-drag: none;
  object-fit: contain;
  background: rgba(255,255,255,0.15);
}
#canvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  cursor: crosshair;
}

/* Bottom control bar */
#bottomBar{
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  bottom: 16px;
  z-index: 9999;

  width: min(1100px, 95vw);
  background: rgba(255,255,255,0.55);
  border: 1px solid rgba(72,38,29,0.25);
  border-radius: 18px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.18);

  padding: 10px 12px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
}

button{
  padding: 9px 14px;
  border-radius: 14px;
  border: 2px solid rgba(72,38,29,0.25);
  background: var(--sky);
  color: var(--choco);
  font-weight: 800;
  cursor:pointer;
}
button:active{ transform: translateY(1px); }
button.danger{ background: var(--claret); color: white; }

.zoomLabel{
  font-weight: 800;
  opacity: 0.85;
  padding: 0 6px;
}

#guessWrap{
  display:flex;
  gap:10px;
  align-items:center;
  flex: 1;
  justify-content:center;
  min-width: 260px;
}
#guessInput{
  flex: 1;
  min-width: 180px;
  max-width: 520px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 2px solid rgba(72,38,29,0.25);
  background: rgba(255,255,255,0.75);
  color: var(--choco);
  font-weight: 700;
  outline: none;
}
#guessInput.bad{ border-color: var(--bad); box-shadow: 0 0 0 3px rgba(204,0,0,0.18); }
#guessInput.good{ border-color: var(--good); box-shadow: 0 0 0 3px rgba(22,163,74,0.18); }

.hidden{ display:none !important; }

/* Make sure the fixed bottom bar doesn't cover scroll end */
.pad-bottom{ height: 110px; }
</style>
</head>

<body>
  <div id="pageTitleBar">
    <div id="topTitle">Evropa mÄ›sta</div>
  </div>

  <div id="findSticky">
    <div id="findText">Loadingâ€¦</div>
  </div>

  <div class="container">
    <div class="map-card">
      <div class="top-strip">
        <div id="title">Map Quiz</div>
        <span id="status">Mode: â€¦</span>
      </div>

      <div id="viewport">
        <div id="stage">
          <img id="map" src="map.png" alt="Map">
          <canvas id="canvas"></canvas>
        </div>
      </div>

      <div class="pad-bottom"></div>
    </div>
  </div>

  <div id="bottomBar">
    <!-- Mode selector -->
    <button id="modeClick" type="button">Find & click</button>
    <button id="modeType" type="button">Show dot & type</button>

    <!-- Typing UI (only in type mode) -->
    <div id="guessWrap" class="hidden">
      <input id="guessInput" type="text" placeholder="Type the city nameâ€¦" autocomplete="off" />
      <button id="guessBtn" type="button">Submit</button>
      <button id="skipBtn" type="button">Skip</button>
    </div>

    <!-- Zoom + reset -->
    <button id="zoomOut" type="button">âˆ’</button>
    <button id="zoomIn" type="button">+</button>
    <button id="zoomReset" type="button">Reset zoom</button>
    <span class="zoomLabel" id="zoomLabel">100%</span>

    <button class="danger" id="resetQuiz" type="button">Reset quiz</button>
  </div>

<script>
/* ========= POINTS ========= */
const points = JSON.parse(`[{"x":0.19773859350081582,"y":0.8137879086784197,"name":"Madrid"},{"x":0.08920849116721612,"y":0.8344482505066446,"name":"Lisabon"},{"x":0.112537391668831,"y":0.7759106153266737,"name":"Porto"},{"x":0.37371964728473683,"y":0.53085600530856,"name":"Rotterdam"},{"x":0.37473394730654613,"y":0.5216736311626823,"name":"Haag"},{"x":0.21903889395881201,"y":0.7420506106637493,"name":"Bilbao"},{"x":0.14296639232311129,"y":0.880934019620151,"name":"Sevilla"},{"x":0.2504821946349016,"y":0.847647913341344,"name":"Valencie"},{"x":0.3874126975791629,"y":0.5153607489373913,"name":"Amsterdam"},{"x":0.3701695972084041,"y":0.5589770261303108,"name":"Brusel"},{"x":0.39248419768820964,"y":0.591115335640883,"name":"Lucemburk"},{"x":0.16972547743055555,"y":0.9104166666666667,"name":"MalÃ¡ga"},{"x":0.30080661252248203,"y":0.8104166666666667,"name":"Barcelona"},{"x":0.2691409450564548,"y":0.70625,"name":"Bourdeaux"},{"x":0.36340153658323343,"y":0.7620833333333333,"name":"Marseilles"},{"x":0.22348347103567145,"y":0.5970833333333333,"name":"Brest"},{"x":0.3324722799885092,"y":0.6204166666666666,"name":"PaÅ™Ã­Å¾"},{"x":0.3479369082858713,"y":0.56375,"name":"Lille"},{"x":0.41495029757444046,"y":0.62625,"name":"Å trasburk"},{"x":0.35382819525629494,"y":0.6970833333333334,"name":"Lyon"},{"x":0.2698773559277578,"y":0.6204166666666666,"name":"Rennes"},{"x":0.15205161651928456,"y":0.11208333333333333,"name":"Reykjavik"},{"x":0.1844536948566147,"y":0.485,"name":"Cork"},{"x":0.22716552539218623,"y":0.4583333333333333,"name":"Dublin"},{"x":0.2382116884617306,"y":0.43583333333333335,"name":"Newcastle"},{"x":0.23894809933303357,"y":0.42583333333333334,"name":"Belfast"},{"x":0.2698773559277578,"y":0.39916666666666667,"name":"Glasgow"},{"x":0.3022794342650879,"y":0.5258333333333334,"name":"LondÃ½n"},{"x":0.26177683634342525,"y":0.5158333333333334,"name":"Cardiff"},{"x":0.28902403858163467,"y":0.49416666666666664,"name":"Birmingham"},{"x":0.27355941028427255,"y":0.47333333333333333,"name":"Liverpool"},{"x":0.2846055733538169,"y":0.4691666666666667,"name":"Manchester"},{"x":0.475335989021283,"y":0.31875,"name":"Oslo"},{"x":0.41495029757444046,"y":0.30541666666666667,"name":"Bergen"},{"x":0.5673873479341527,"y":0.33625,"name":"Stockholm"},{"x":0.560759650092426,"y":0.32375,"name":"Uppsala"},{"x":0.5040560130020983,"y":0.43875,"name":"Malmo"},{"x":0.4959554934177658,"y":0.43625,"name":"KodaÅˆ"},{"x":0.48785497383343324,"y":0.3720833333333333,"name":"Goteborg"},{"x":0.6542838307479016,"y":0.29791666666666666,"name":"Helsinky"},{"x":0.6167268763114508,"y":0.29875,"name":"Turku"},{"x":0.7154059330660472,"y":0.2970833333333333,"name":"Petrohrad"},{"x":0.6564930633618106,"y":0.32208333333333333,"name":"Tallin"},{"x":0.6461833111635692,"y":0.39375,"name":"Riga"},{"x":0.6712212807878697,"y":0.45458333333333334,"name":"Vilnius"},{"x":0.7198243982938649,"y":0.4675,"name":"Minsk"},{"x":0.6167268763114508,"y":0.5266666666666666,"name":"VarÅ¡ava"},{"x":0.5806427436176059,"y":0.4725,"name":"GdaÅˆsk"},{"x":0.5600232392211231,"y":0.5591666666666667,"name":"Wroclaw"},{"x":0.6093627675984212,"y":0.585,"name":"Krakov"},{"x":0.6012622480140888,"y":0.5475,"name":"LodÅ¾"},{"x":0.5519227196367905,"y":0.525,"name":"PoznaÅˆ"},{"x":0.5025831912594924,"y":0.5241666666666667,"name":"BerlÃ­n"},{"x":0.45839853898131494,"y":0.5025,"name":"Hamburk"},{"x":0.5114201217151279,"y":0.5625,"name":"DrÃ¡Å¾Äany"},{"x":0.4804908651204037,"y":0.64,"name":"Mnichov"},{"x":0.4385154454561351,"y":0.5816666666666667,"name":"Franfurt nad Mohanem"},{"x":0.47091752379346524,"y":0.5283333333333333,"name":"Wolfsburg"},{"x":0.48638215209082736,"y":0.5566666666666666,"name":"Lipsko"},{"x":0.4090590106040168,"y":0.5458333333333333,"name":"Dusseldorf"},{"x":0.41347747583183453,"y":0.5566666666666666,"name":"KolÃ­n na RÃ½nem"},{"x":0.35456460612759794,"y":0.5441666666666667,"name":"Bruggy"},{"x":0.3722384670388689,"y":0.5466666666666666,"name":"Antverpy"},{"x":0.388439506207534,"y":0.5658333333333333,"name":"Lutych"},{"x":0.40832259973271384,"y":0.6683333333333333,"name":"Bern"},{"x":0.4421974998126499,"y":0.6683333333333333,"name":"Vaduz"},{"x":0.4296785150004996,"y":0.6566666666666666,"name":"Curych"},{"x":0.38549386272232217,"y":0.6866666666666666,"name":"Å½eneva"},{"x":0.3928579714353517,"y":0.6783333333333333,"name":"Lausane"},{"x":0.40464054537619903,"y":0.7225,"name":"TurÃ­n"},{"x":0.42526004977268184,"y":0.7391666666666666,"name":"Janov"},{"x":0.4348333910996203,"y":0.7125,"name":"MilÃ¡n"},{"x":0.4458795541691647,"y":0.705,"name":"Bergamo"},{"x":0.48859138470473623,"y":0.7133333333333334,"name":"BenÃ¡tky"},{"x":0.4016949018909872,"y":0.7558333333333334,"name":"Monako/Nice"},{"x":0.4657626476943445,"y":0.7383333333333333,"name":"Bologna"},{"x":0.46208059333782975,"y":0.7608333333333334,"name":"Florencie"},{"x":0.4900642064473421,"y":0.7566666666666667,"name":"San Marino/Rimini"},{"x":0.48932779557603917,"y":0.8133333333333334,"name":"Å˜Ã­m/VatikÃ¡n"},{"x":0.5180478195568545,"y":0.8408333333333333,"name":"Neapol"},{"x":0.5033196021307954,"y":0.915,"name":"Palermo"},{"x":0.47459957814998,"y":0.665,"name":"Innsbruck"},{"x":0.5018467803881894,"y":0.65,"name":"Salzburk"},{"x":0.5202570521707633,"y":0.6408333333333334,"name":"Linz"},{"x":0.5519227196367905,"y":0.6416666666666667,"name":"VÃ­deÅˆ"},{"x":0.5681237588054556,"y":0.6408333333333334,"name":"Bratislava"},{"x":0.6285094502522982,"y":0.6241666666666666,"name":"KoÅ¡ice"},{"x":0.6299822719949041,"y":0.6133333333333333,"name":"PreÅ¡ov"},{"x":0.5997894262714828,"y":0.6191666666666666,"name":"BanskÃ¡ Bystrica"},{"x":0.5924253175584533,"y":0.6116666666666667,"name":"Å½ilina"},{"x":0.5821155653602118,"y":0.6266666666666667,"name":"Nitra"},{"x":0.6005258371427857,"y":0.6583333333333333,"name":"BudapeÅ¡Å¥"},{"x":0.5246755173985811,"y":0.6966666666666667,"name":"LublaÅˆ"},{"x":0.5497134870228817,"y":0.7041666666666667,"name":"ZÃ¡hÅ™eb"},{"x":0.5909524958158473,"y":0.7541666666666667,"name":"Sarajevo"},{"x":0.5651781153202438,"y":0.7333333333333333,"name":"Banja Luka"},{"x":0.5578140066072143,"y":0.7666666666666667,"name":"Split"},{"x":0.578433511003697,"y":0.7816666666666666,"name":"Dubrovnik"},{"x":0.597580193657574,"y":0.6958333333333333,"name":"Szged"},{"x":0.5857976197167266,"y":0.6966666666666667,"name":"PÃ©cs"},{"x":0.6402920241931455,"y":0.6516666666666666,"name":"Debrecen"},{"x":0.6078899458558154,"y":0.79,"name":"Podgorica"},{"x":0.6299822719949041,"y":0.7375,"name":"BÄ›lohrad"},{"x":0.6432376676783573,"y":0.7858333333333334,"name":"PriÅ¡tina"},{"x":0.6211453415392686,"y":0.8266666666666667,"name":"Tirana"},{"x":0.6520745981339928,"y":0.8041666666666667,"name":"Skopje"},{"x":0.6181996980540567,"y":0.7208333333333333,"name":"Novi Sad"},{"x":0.7028869482538969,"y":0.9075,"name":"AthÃ©ny"},{"x":0.6785853895008993,"y":0.8383333333333334,"name":"SoluÅˆ"},{"x":0.6852130873426259,"y":0.7775,"name":"Sofie"},{"x":0.7117238787095324,"y":0.7875,"name":"Plovdiv"},{"x":0.7617998179581335,"y":0.7516666666666667,"name":"Varna"},{"x":0.753699298373801,"y":0.7783333333333333,"name":"Burgas"},{"x":0.7316069722347123,"y":0.7125,"name":"BukurÅ¡Å¥"},{"x":0.6704848699165668,"y":0.6633333333333333,"name":"KluÅ¾"},{"x":0.7566449418590128,"y":0.645,"name":"KiÅ¡inÄ›v"},{"x":0.7743188027702838,"y":0.5491666666666667,"name":"Kyjev"},{"x":0.8766799138813949,"y":0.5416666666666666,"name":"Charkov"},{"x":0.7919926636815547,"y":0.6525,"name":"Odesa "},{"x":0.8501691225144884,"y":0.6925,"name":"Sevastopol"},{"x":0.6844766764713229,"y":0.58,"name":"Lvov"},{"x":0.910554813961331,"y":0.5608333333333333,"name":"Luhansk"},{"x":0.8781527356240008,"y":0.5933333333333334,"name":"DonÄ›ck"},{"x":0.961367164081235,"y":0.685,"name":"SoÄi"},{"x":0.926019442258693,"y":0.5883333333333334,"name":"Rostov na Donu"},{"x":0.9878779554481415,"y":0.5491666666666667,"name":"Volgograd"},{"x":0.8516419442570944,"y":0.40291666666666665,"name":"Moskva"},{"x":0.9495845901403877,"y":0.38375,"name":"NiÅ¾nij Novgorod"},{"x":0.5497134870228817,"y":0.08958333333333333,"name":"Narvik"},{"x":0.5070016564873101,"y":0.7058333333333333,"name":"Terst"}]`);

/* ========= DOM ========= */
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const img = document.getElementById('map');
const viewport = document.getElementById('viewport');
const stage = document.getElementById('stage');

const statusEl = document.getElementById('status');
const findSticky = document.getElementById('findSticky');
const findText = document.getElementById('findText');

const guessWrap = document.getElementById('guessWrap');
const guessInput = document.getElementById('guessInput');
const guessBtn = document.getElementById('guessBtn');
const skipBtn = document.getElementById('skipBtn');

const modeClickBtn = document.getElementById('modeClick');
const modeTypeBtn  = document.getElementById('modeType');

/* ========= UI helpers ========= */
function setTarget(t){ findText.textContent = t; }
function flashWrong(){
  findSticky.classList.add("wrong");
  findText.classList.add("wrong");
  setTimeout(() => {
    findSticky.classList.remove("wrong");
    findText.classList.remove("wrong");
  }, 260);
}

/* Normalize text so "LondÃ½n" == "londyn" */
function normText(s){
  return (s || "")
    .trim()
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/\s+/g, " ");
}

/* ========= QUIZ STATE ========= */
const MODE_CLICK = "click";
const MODE_TYPE  = "type";
let mode = MODE_CLICK;

let solved = new Set();
let failed = new Set();
let attempts = 0;
let currentIndex = -1;

const DOT_MM = 2;            // ~2mm dots
const HIT_RADIUS_PX = 12;    // click tolerance
const MAX_TRIES = 3;

/* wrong visuals */
let wrongMark = null;   // {x,y, until}
let revealIndex = -1;   // index to ring
let revealUntil = 0;    // timestamp

/* ========= ZOOM STATE ========= */
let zoom = 1;
const ZOOM_MIN = 1;
const ZOOM_MAX = 4;
const ZOOM_STEP = 0.2;

let baseW = 0, baseH = 0;
let stageW = 1, stageH = 1;       // CSS pixels
let dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

function setZoomLabel(){ document.getElementById("zoomLabel").innerText = Math.round(zoom*100) + "%"; }
function mmToPx(mm){ return mm * (96/25.4); } // approx at 96dpi

function getEventPosInCanvas(e){
  const r = canvas.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top }; // CSS px
}

function computeBaseSize(){
  const vw = viewport.clientWidth;
  const vh = viewport.clientHeight;

  const iw = img.naturalWidth || 1;
  const ih = img.naturalHeight || 1;
  const ratio = iw / ih;

  let w = vw;
  let h = w / ratio;
  if (h > vh){
    h = vh;
    w = h * ratio;
  }
  baseW = Math.max(1, Math.floor(w));
  baseH = Math.max(1, Math.floor(h));
}

function getViewportCenter(){
  return {
    x: viewport.scrollLeft + viewport.clientWidth / 2,
    y: viewport.scrollTop + viewport.clientHeight / 2,
    zoom
  };
}
function setViewportCenter(x, y){
  viewport.scrollLeft = Math.max(0, x - viewport.clientWidth / 2);
  viewport.scrollTop  = Math.max(0, y - viewport.clientHeight / 2);
}

function applyZoom(keepCenter=true){
  if (!baseW || !baseH) computeBaseSize();
  dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

  const center = keepCenter ? getViewportCenter() : null;

  stageW = Math.floor(baseW * zoom);
  stageH = Math.floor(baseH * zoom);

  stage.style.width  = stageW + "px";
  stage.style.height = stageH + "px";

  // HiDPI canvas: actual buffer is scaled by dpr, but we draw in CSS px
  canvas.style.width  = stageW + "px";
  canvas.style.height = stageH + "px";
  canvas.width  = Math.floor(stageW * dpr);
  canvas.height = Math.floor(stageH * dpr);

  ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // now 1 unit = 1 CSS px

  // keep map image synced
  // (img is absolutely positioned, sized via CSS, so nothing else needed)

  draw();

  if (center){
    const scale = zoom / center.zoom;
    setViewportCenter(center.x * scale, center.y * scale);
  }
  setZoomLabel();
}

function normToPx(p){
  return { x: p.x * stageW, y: p.y * stageH }; // CSS px coords
}

/* ========= DRAW ========= */
function draw(){
  // Clear in CSS px space (transform already set)
  ctx.clearRect(0,0,stageW,stageH);

  const good = getComputedStyle(document.documentElement).getPropertyValue('--good').trim() || "#16a34a";
  const bad  = getComputedStyle(document.documentElement).getPropertyValue('--bad').trim()  || "#cc0000";
  const dot  = getComputedStyle(document.documentElement).getPropertyValue('--dot').trim()  || "#0420f9";

  const radius = mmToPx(DOT_MM) / 2;

  if(mode === MODE_CLICK){
    // draw all points
    for(let i=0;i<points.length;i++){
      const pos = normToPx(points[i]);
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, radius, 0, Math.PI*2);
      if (solved.has(i)) ctx.fillStyle = good;
      else if (failed.has(i)) ctx.fillStyle = bad;
      else ctx.fillStyle = dot;
      ctx.fill();
    }
  } else {
    // draw only current point
    if(currentIndex >= 0){
      const pos = normToPx(points[currentIndex]);
      ctx.beginPath();
      ctx.arc(pos.x, pos.y, radius, 0, Math.PI*2);
      ctx.fillStyle = dot;
      ctx.fill();
    }
  }

  const now = performance.now();

  // Wrong click marker (red X)
  if (wrongMark && now < wrongMark.until){
    ctx.save();
    ctx.lineWidth = 4;
    ctx.strokeStyle = bad;
    ctx.beginPath();
    ctx.moveTo(wrongMark.x - 10, wrongMark.y - 10);
    ctx.lineTo(wrongMark.x + 10, wrongMark.y + 10);
    ctx.moveTo(wrongMark.x + 10, wrongMark.y - 10);
    ctx.lineTo(wrongMark.x - 10, wrongMark.y + 10);
    ctx.stroke();
    ctx.restore();
  }

  // Reveal ring
  if (revealIndex >= 0 && now < revealUntil){
    const pos = normToPx(points[revealIndex]);
    ctx.save();
    ctx.lineWidth = 6;
    ctx.strokeStyle = bad;
    ctx.beginPath();
    ctx.arc(pos.x, pos.y, 22, 0, Math.PI*2);
    ctx.stroke();
    ctx.restore();
  }
}

/* ========= PICK NEXT ========= */
function remainingIndices(){
  const arr = [];
  for(let i=0;i<points.length;i++){
    if(!solved.has(i) && !failed.has(i)) arr.push(i);
  }
  return arr;
}

function pickNext(){
  attempts = 0;
  wrongMark = null;
  revealIndex = -1;

  const remaining = remainingIndices();
  if(remaining.length === 0){
    currentIndex = -1;
    setTarget("Finished ðŸŽ‰");
    statusEl.textContent = `Mode: ${mode === MODE_CLICK ? "Find & click" : "Show dot & type"} (done)`;
    draw();
    return;
  }

  currentIndex = remaining[(Math.random()*remaining.length)|0];

  if(mode === MODE_CLICK){
    setTarget("Find: " + (points[currentIndex].name || "â€”"));
  } else {
    setTarget("Name this city");
    guessInput.value = "";
    guessInput.focus();
  }
  statusEl.textContent = `Mode: ${mode === MODE_CLICK ? "Find & click" : "Show dot & type"} (${remaining.length} left)`;
  draw();
}

/* ========= MODE SWITCH ========= */
function setMode(newMode){
  mode = newMode;

  // Reset progress when switching modes (simple + predictable)
  solved = new Set();
  failed = new Set();
  attempts = 0;
  currentIndex = -1;
  wrongMark = null;
  revealIndex = -1;
  revealUntil = 0;

  if(mode === MODE_TYPE){
    guessWrap.classList.remove("hidden");
  } else {
    guessWrap.classList.add("hidden");
  }

  pickNext();
}

modeClickBtn.addEventListener("click", ()=>setMode(MODE_CLICK));
modeTypeBtn.addEventListener("click",  ()=>setMode(MODE_TYPE));

/* ========= CLICK MODE HANDLER ========= */
viewport.addEventListener("click", (e)=>{
  if(mode !== MODE_CLICK) return;
  if(currentIndex < 0) return;

  const pos = getEventPosInCanvas(e);
  const target = normToPx(points[currentIndex]);
  const dist = Math.hypot(target.x - pos.x, target.y - pos.y);

  if(dist <= HIT_RADIUS_PX){
    solved.add(currentIndex);
    pickNext();
    return;
  }

  attempts++;
  flashWrong();
  wrongMark = { x: pos.x, y: pos.y, until: performance.now() + 650 };

  if(attempts >= MAX_TRIES){
    revealIndex = currentIndex;
    revealUntil = performance.now() + 1200;
    failed.add(currentIndex);
    attempts = 0;
    // tiny delay so ring is visible before next question
    draw();
    setTimeout(pickNext, 450);
    return;
  }
  draw();
});

/* ========= TYPE MODE HANDLER ========= */
function submitGuess(){
  if(mode !== MODE_TYPE) return;
  if(currentIndex < 0) return;

  const guess = normText(guessInput.value);
  const answer = normText(points[currentIndex].name);

  if(!guess){
    guessInput.classList.add("bad");
    setTimeout(()=>guessInput.classList.remove("bad"), 450);
    return;
  }

  if(guess === answer){
    solved.add(currentIndex);
    guessInput.classList.add("good");
    setTimeout(()=>guessInput.classList.remove("good"), 450);
    draw();
    setTimeout(pickNext, 300);
    return;
  }

  attempts++;
  flashWrong();
  guessInput.classList.add("bad");
  setTimeout(()=>guessInput.classList.remove("bad"), 450);

  if(attempts >= MAX_TRIES){
    revealIndex = currentIndex;
    revealUntil = performance.now() + 1200;
    failed.add(currentIndex);

    // Show answer briefly in the top bubble
    setTarget("It was: " + points[currentIndex].name);
    draw();
    setTimeout(pickNext, 950);
    return;
  }

  guessInput.select();
  draw();
}

guessBtn.addEventListener("click", submitGuess);
guessInput.addEventListener("keydown", (e)=>{ if(e.key === "Enter") submitGuess(); });

skipBtn.addEventListener("click", ()=>{
  if(mode !== MODE_TYPE) return;
  if(currentIndex < 0) return;
  failed.add(currentIndex);
  setTarget("Skipped: " + points[currentIndex].name);
  draw();
  setTimeout(pickNext, 500);
});

/* ========= RESET ========= */
document.getElementById("resetQuiz").addEventListener("click", ()=>{
  if(!confirm("Reset quiz progress?")) return;
  solved = new Set();
  failed = new Set();
  attempts = 0;
  wrongMark = null;
  revealIndex = -1;
  revealUntil = 0;
  pickNext();
});

/* ========= ZOOM BUTTONS ========= */
document.getElementById("zoomIn").onclick = ()=>{
  zoom = Math.min(ZOOM_MAX, zoom + ZOOM_STEP);
  applyZoom(true);
};
document.getElementById("zoomOut").onclick = ()=>{
  zoom = Math.max(ZOOM_MIN, zoom - ZOOM_STEP);
  applyZoom(true);
};
document.getElementById("zoomReset").onclick = ()=>{
  zoom = 1;
  viewport.scrollLeft = 0;
  viewport.scrollTop = 0;
  applyZoom(false);
};

/* ========= TRACKPAD PINCH (Chrome/Edge) ========= */
viewport.addEventListener("wheel", (e)=>{
  if(!e.ctrlKey) return;
  e.preventDefault();

  const factor = e.deltaY > 0 ? 0.94 : 1.06;
  const newZoom = Math.min(ZOOM_MAX, Math.max(ZOOM_MIN, zoom * factor));
  if(newZoom === zoom) return;

  zoom = newZoom;
  applyZoom(true);
}, { passive:false });

/* ========= TOUCH: 1-finger pan + 2-finger pinch ========= */
const pointers = new Map();
let pinchStartDist = 0;
let pinchStartZoom = 1;

let panPointerId = null;
let panStartX = 0, panStartY = 0;
let panStartScrollLeft = 0, panStartScrollTop = 0;

function dist2(a,b){
  const dx = a.x - b.x;
  const dy = a.y - b.y;
  return Math.hypot(dx, dy);
}
function startPan(pointerId, x, y){
  panPointerId = pointerId;
  panStartX = x;
  panStartY = y;
  panStartScrollLeft = viewport.scrollLeft;
  panStartScrollTop  = viewport.scrollTop;
}
function stopPan(pointerId){
  if (panPointerId === pointerId) panPointerId = null;
}

viewport.addEventListener("pointerdown", (e)=>{
  viewport.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

  if (pointers.size === 1){
    startPan(e.pointerId, e.clientX, e.clientY);
  }
  if (pointers.size === 2){
    panPointerId = null;
    const pts = Array.from(pointers.values());
    pinchStartDist = dist2(pts[0], pts[1]);
    pinchStartZoom = zoom;
  }
});

viewport.addEventListener("pointermove", (e)=>{
  if (!pointers.has(e.pointerId)) return;
  pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });

  // pinch zoom
  if (pointers.size === 2){
    const pts = Array.from(pointers.values());
    const d = dist2(pts[0], pts[1]);

    if (pinchStartDist > 0){
      const scale = d / pinchStartDist;
      let newZoom = pinchStartZoom * scale;
      newZoom = Math.min(ZOOM_MAX, Math.max(ZOOM_MIN, newZoom));
      if (Math.abs(newZoom - zoom) > 0.0005){
        zoom = newZoom;
        applyZoom(true);
      }
    }
    e.preventDefault();
    return;
  }

  // pan (only when zoomed)
  if (pointers.size === 1 && panPointerId === e.pointerId && zoom > 1){
    const dx = e.clientX - panStartX;
    const dy = e.clientY - panStartY;
    viewport.scrollLeft = panStartScrollLeft - dx;
    viewport.scrollTop  = panStartScrollTop  - dy;
    e.preventDefault();
  }
}, { passive:false });

function endPointer(e){
  pointers.delete(e.pointerId);
  stopPan(e.pointerId);

  if (pointers.size < 2){
    pinchStartDist = 0;
    pinchStartZoom = zoom;
  }
  if (pointers.size === 1){
    const [id, p] = pointers.entries().next().value;
    startPan(id, p.x, p.y);
  }
}
viewport.addEventListener("pointerup", endPointer);
viewport.addEventListener("pointercancel", endPointer);

/* ========= VIEWPORT HEIGHT ========= */
function setViewportHeight(){
  const reservedTop = 140;
  const reservedBottom = 150; // bottom bar breathing room
  const h = Math.max(320, window.innerHeight - (reservedTop + reservedBottom));
  viewport.style.height = h + "px";
}

/* ========= INIT ========= */
function init(){
  // if map.png doesn't load, everything "works" but you see nothing useful
  setViewportHeight();
  computeBaseSize();
  zoom = 1;
  applyZoom(false);

  // default mode
  setMode(MODE_CLICK);
}

img.addEventListener("load", init);
window.addEventListener("resize", ()=>{
  setViewportHeight();
  computeBaseSize();
  applyZoom(false);
});
if (img.complete) init();
</script>
</body>
</html>
